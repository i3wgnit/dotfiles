\RequirePackage{twlbase}
\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage{twlthm}{11/27/2019}{}{}

%% Parse Arguments
% Boolean toggles
\bool_new:N \g__twlthm_frame_bool
\bool_gset_true:N \g__twlthm_frame_bool

\bool_new:N \g__twlthm_colour_bool
\@ifpackageloaded{xcolor}{\bool_gset_true:N \g__twlthm_colour_bool}{}

\bool_new:N \g__twlthm_thmsec_bool
\bool_gset_true:N \g__twlthm_thmsec_bool

\bool_new:N \g__twlthm_index_bool
\bool_gset_true:N \g__twlthm_index_bool

\bool_new:N \g__twlthm_thm_bool
\bool_gset_true:N \g__twlthm_thm_bool

% Options
\DeclareOption{nothm}
{
  \bool_gset_false:N \g__twlthm_thm_bool
  \bool_gset_false:N \g__twlthm_index_bool
  \bool_gset_false:N \g__twlthm_thmsec_bool
  \bool_gset_false:N \g__twlthm_colour_bool
  \bool_gset_false:N \g__twlthm_frame_bool
}
\DeclareOption{thm}{\bool_gset_false:N \g__twlthm_thm_bool}

\DeclareOption{noindex}{\bool_gset_false:N \g__twlthm_index_bool}
\DeclareOption{index}{\bool_gset_false:N \g__twlthm_index_bool}

\DeclareOption{nothmsec}{\bool_gset_false:N \g__twlthm_thmsec_bool}
\DeclareOption{thmsec}{\bool_gset_false:N \g__twlthm_thmsec_bool}

\DeclareOption{nocolor}{\bool_gset_false:N \g__twlthm_colour_bool}
\DeclareOption{color}{\bool_gset_true:N \g__twlthm_colour_bool}
\DeclareOption{nocolour}{\bool_gset_false:N \g__twlthm_colour_bool}
\DeclareOption{colour}{\bool_gset_true:N \g__twlthm_colour_bool}

\DeclareOption{noframe}{\bool_gset_false:N \g__twlthm_frame_bool}
\DeclareOption{frame}{\bool_gset_true:N \g__twlthm_frame_bool}

\ProcessOptions\relax

%% Package
\PassOptionsToPackage{amsmath, thmmarks, thref, hyperref}{ntheorem}
\RequirePackage{amsmath}
\RequirePackage{hyperref}
\RequirePackage{ntheorem}
\usetagform{default}

\tl_new:N \l__twlthm_plain_tl
\tl_set:Nn \l__twlthm_plain_tl {plain}
\tl_new:N \l__twlthm_nonumber_plain_tl
\tl_set:Nn \l__twlthm_nonumber_plain_tl {nonumberplain}
\tl_new:N \l__twlthm_break_tl
\tl_set:Nn \l__twlthm_break_tl {break}
\tl_new:N \l__twlthm_nonumber_break_tl
\tl_set:Nn \l__twlthm_nonumber_break_tl {nonumberbreak}

\bool_if:NT \g__twlthm_colour_bool
{
  \PassOptionsToPackage{usenames,svgnames,dvipsnames}{xcolor}
  \RequirePackage{xcolor}
}

\bool_if:NT \g__twlthm_frame_bool
{
  \PassOptionsToPackage{framemethod=TikZ}{mdframed}
  \RequirePackage{framed}
  \RequirePackage{mdframed}
  \cs_new:Npn \__twlthm_mdfthm:
  {
    \theoremprework{\begin{mdframed}}
      \theorempostwork{\end{mdframed}}
  }
  \cs_new:Npn \__twlthm_mdfthm:n #1
  {
    \theoremprework{\begin{mdframed}[style=#1]}
      \theorempostwork{\end{mdframed}}
  }

  \tl_new:N \l__twlthm_mdstyle_bluebox_tl
  \tl_new:N \l__twlthm_mdstyle_redbox_tl
  \tl_new:N \l__twlthm_mdstyle_blackbox_tl

  \bool_if:NT \g__twlthm_colour_bool
  {
    \mdfdefinestyle{mdbluebox}{
      nobreak=true,
      skipabove=8pt,
      innerbottommargin=9pt,
      skipbelow=4pt,
      leftline=true,
      rightline=false,
      topline=false,
      bottomline=false,
      linewidth=3pt,
      linecolor=NavyBlue!75,
      backgroundcolor=TealBlue!5,
    }
    \tl_set:Nn \l__twlthm_mdstyle_bluebox_tl {mdbluebox}

    \mdfdefinestyle{mdredbox}{
      nobreak=true,
      skipabove=8pt,
      innertopmargin=4pt,
      innerbottommargin=8pt,
      skipbelow=4pt,
      leftline=true,
      rightline=false,
      topline=false,
      bottomline=false,
      linewidth=3pt,
      linecolor=BrickRed!60!Sepia,
      backgroundcolor=Salmon!5,
    }
    \tl_set:Nn \l__twlthm_mdstyle_redbox_tl {mdredbox}

    \mdfdefinestyle{mdblackbox}{
      nobreak=true,
      skipabove=8pt,
      innertopmargin=4pt,
      innerbottommargin=8pt,
      skipbelow=4pt,
      leftline=true,
      rightline=false,
      topline=false,
      bottomline=false,
      linewidth=3pt,
      linecolor=Black,
      backgroundcolor=Black!5,
    }
    \tl_set:Nn \l__twlthm_mdstyle_blackbox_tl {mdblackbox}
  }

  \newtheoremstyle{twlthmboxedplain}
  {\item[\hskip\labelsep \theorem@headerfont ##1\ ##2\theorem@separator]}
  {\item[\rlap{\vbox{\hbox{\hskip\labelsep \theorem@headerfont
          ##1\ ##2\ (##3)\theorem@separator}\smallskip{}\hbox{\strut}}}]}
  \tl_set:Nn \l__twlthm_plain_tl {twlthmboxedplain}

  \newtheoremstyle{nonumbertwlthmboxedplain}
  {\item[\hskip\labelsep \theorem@headerfont ##1\theorem@separator]}
  {\item[\rlap{\vbox{\hbox{\hskip\labelsep \theorem@headerfont
          ##1\ (##3)\theorem@separator}\smallskip{}\hbox{\strut}}}]}
  \tl_set:Nn \l__twlthm_nonumber_plain_tl {nonumbertwlthmboxedplain}

  \newtheoremstyle{twlthmboxedbreak}
  {\item[\rlap{\vbox{\hbox{\hskip\labelsep \theorem@headerfont
          ##1\ ##2\theorem@separator}\smallskip{}\hbox{\strut}}}]}
  {\item[\rlap{\vbox{\hbox{\hskip\labelsep \theorem@headerfont
          ##1\ ##2\ (##3)\theorem@separator}\smallskip{}\hbox{\strut}}}]}
  \tl_set:Nn \l__twlthm_break_tl {twlthmboxedbreak}

  \newtheoremstyle{nonumbertwlthmboxedbreak}
  {\item[\rlap{\vbox{\hbox{\hskip\labelsep \theorem@headerfont
          ##1\theorem@separator}\smallskip{}\hbox{\strut}}}]}
  {\item[\rlap{\vbox{\hbox{\hskip\labelsep \theorem@headerfont
          ##1\ (##3)\theorem@separator}\smallskip{}\hbox{\strut}}}]}
  \tl_set:Nn \l__twlthm_nonumber_break_tl {nonumbertwlthmboxedbreak}
}

\cs_new:Npn \__twlthm_plain_sty:
{
  \theoremstyle{\l__twlthm_plain_tl}
  \theoremheaderfont{\bfseries}
  \theorembodyfont{\normalfont}
  \theoremseparator{}
  \theoremprework{}
  \theorempostwork{}
  \theoremsymbol{}
}

\cs_new:Npn \__twlthm_thm_sty:
{
  \theoremstyle{\l__twlthm_break_tl}
  \theoremheaderfont{\sffamily\bfseries
    \bool_if:NT \g__twlthm_colour_bool
    {\color{MidnightBlue}}
  }
  \theorembodyfont{\normalfont}
  \theoremnumbering{arabic}
  \theoremseparator{}
  \bool_if:NT \g__twlthm_frame_bool
  {
    \tl_if_empty:NTF \l__twlthm_mdstyle_bluebox_tl
    {\__twlthm_mdfthm:}
    {\__twlthm_mdfthm:n {\l__twlthm_mdstyle_bluebox_tl}}
  }
  \theoremsymbol{}
}

\cs_new:Npn \__twlthm_def_sty:
{
  \theoremstyle{\l__twlthm_plain_tl}
  \theoremheaderfont{\bfseries
    \bool_if:NT \g__twlthm_colour_bool
    {\color{RawSienna}}
  }
  \theorembodyfont{\normalfont}
  \theoremnumbering{arabic}
  \theoremseparator{}
  \bool_if:NT \g__twlthm_frame_bool
  {
    \tl_if_empty:NTF \l__twlthm_mdstyle_redbox_tl
    {\__twlthm_mdfthm:}
    {\__twlthm_mdfthm:n {\l__twlthm_mdstyle_redbox_tl}}
  }
  \theoremsymbol{}
}

\cs_new:Npn \__twlthm_remark_sty:
{
  \theoremstyle{\l__twlthm_break_tl}
  \theoremheaderfont{\bfseries}
  \theorembodyfont{\normalfont}
  \theoremseparator{}
  \bool_if:NT \g__twlthm_frame_bool
  {
    \tl_if_empty:NTF \l__twlthm_mdstyle_blackbox_tl
    {\__twlthm_mdfthm:}
    {\__twlthm_mdfthm:n {\l__twlthm_mdstyle_blackbox_tl}}
  }
  \theoremsymbol{}
}

\cs_new:Npn \__twlthm_eg_sty:
{
  \theoremstyle{\l__twlthm_plain_tl}
  \theoremheaderfont{\bfseries}
  \theorembodyfont{\normalfont}
  \theoremnumbering{arabic}
  \theoremseparator{}
  \bool_if:NT \g__twlthm_frame_bool
  {\__twlthm_mdfthm:}
  \theoremsymbol{}
}

\cs_new:Npn \__twlthm_pf_sty:
{
  \theoremstyle{\l__twlthm_plain_tl}
  \theoremheaderfont{\itshape}
  \theorembodyfont{\normalfont}
  \theoremseparator{.}
  \theoremprework{}
  \theorempostwork{}
  \theoremsymbol{\ensuremath{\square}}
}


\bool_if:NT \g__twlthm_index_bool
{
  \RequirePackage{makeidx}
  \makeindex
}


\bool_if:NTF \g__twlthm_thm_bool
{
  \__twlthm_thm_sty:
  \bool_if:NTF \g__twlthm_thmsec_bool
  {\newtheorem{theorem}{Theorem}[section]}
  {\newtheorem{theorem}{Theorem}}


  \cs_new:Npn \__twlthm_newtheorem:nnn #1#2#3
  {
    #1
    \newtheorem{#2}[theorem]{#3}
    #1
    \renewtheorem*{#2*}{#3}
  }

  \cs_new:Npn \__twlthm_newtheorem_:nnn #1#2#3
  {
    #1
    \newtheorem*{#2}{#3}
    #1
    \renewtheorem{#2*}[theorem]{#3}
  }


  \__twlthm_newtheorem:nnn \__twlthm_plain_sty: {notation} {Notation}

  \__twlthm_newtheorem_:nnn \__twlthm_plain_sty: {note} {Note}
  \__twlthm_newtheorem_:nnn \__twlthm_plain_sty: {recall} {Recall}

  \__twlthm_newtheorem:nnn \__twlthm_remark_sty: {remark} {Remark}

  \__twlthm_newtheorem:nnn \__twlthm_thm_sty: {axiom} {Axiom}
  \__twlthm_newtheorem:nnn \__twlthm_thm_sty: {lemma} {Lemma}
  \__twlthm_newtheorem:nnn \__twlthm_thm_sty: {proposition} {Proposition}
  \__twlthm_newtheorem:nnn \__twlthm_thm_sty: {corollary} {Corollary}

  \__twlthm_newtheorem:nnn \__twlthm_def_sty: {definition} {Definition}

  \cs_new:Npn \__twlthm_vocab_colour:e #1 {\emph{#1}}
  \bool_if:NT \g__twlthm_colour_bool
  {\cs_set:Npn \__twlthm_vocab_colour:e #1 {\textbf{\color{Red} #1}}}

  \cs_new:Npn \__twlthm_vocab_index:ee #1#2 {}
  \bool_if:NT \g__twlthm_index_bool
  {
    \cs_set:Npn \__twlthm_vocab_index:ee #1#2
    {
      \IfValueTF {#2}
      {\index{#1 | #2}}
      {\index{#1}}
    }
  }

  \NewDocumentCommand { \vocab } { o m o }
  {
    \__twlthm_vocab_colour:e {#2}
    \__twlthm_vocab_index:ee {\IfValueTF {#1} {#1} {#2}} {#3}
  }

  \__twlthm_newtheorem:nnn \__twlthm_eg_sty: {example} {Example}
  \__twlthm_newtheorem:nnn \__twlthm_eg_sty: {conjecture} {Conjecture}
  \__twlthm_newtheorem:nnn \__twlthm_eg_sty: {exercise} {Exercise}


  \__twlthm_newtheorem_:nnn \__twlthm_pf_sty: {proof} {Proof}
  \__twlthm_newtheorem_:nnn \__twlthm_pf_sty: {solution} {Solution}

  \__twlthm_newtheorem_:nnn
  {
    \__twlthm_pf_sty:
    \theoremsymbol{\ensuremath{\blacksquare}}
  }
  {subproof} {Proof}
}
{
  \__twlthm_pf_sty:
  \newtheorem*{proof}{Proof}
  \__twlthm_pf_sty:
  \newtheorem*{solution}{Solution}

  \__twlthm_pf_sty:
  \theoremsymbol{\ensuremath{\blacksquare}}
  \newtheorem*{subproof}{Proof}
}

\__twlthm_plain_sty:

#!/bin/sh

PROG="$(basename "$0")"
DIRNAME="$(dirname "$0")"

die() {
    echo
    echo error: "$@"
    exit 1
}

usage() {
    printf 'usage: %s <command>\n' "$PROG"
    printf '\n'
    printf '  - git -- direct access to git\n'
    printf '  - sync -- run all the following and pull submodules\n'
    printf '      - init -- generate default files\n'
    printf '      - shortcut -- generate shortcut files\n'
    printf '      - symlink -- generate symlinks\n'
    printf '  - update -- update dotfiles and all submodules\n'
    printf '  - help -- print this message\n'
}

config() {
    command git --git-dir="$HOME"/.dotfiles/ --work-tree="$HOME" "$@"
}

init() {
    "$DIRNAME"/dotfiles/init.sh
}

shortcut() {
    python3 "$DIRNAME"/dotfiles/shortcut.py
}

symlink() {
    "$DIRNAME"/dotfiles/symlink.sh
}

sync() {
    init
    config submodule update --init --recursive
    shortcut
    symlink
}

[ "$#" -le 0 ] && {
    usage
    exit 1
}

COMMAND="$1"
shift 1

case "$COMMAND" in
    git) config "$@" ;;

    sync) sync ;;

    up*) config pull --rebase origin master \
        && config submodule update --remote --rebase \
        && sync \
        || die update failed ;;


    init) init ;;
    short*) shortcut ;;
    sym*) symlink ;;


    h*) usage ;;
    *) config "$COMMAND" "$@"
esac

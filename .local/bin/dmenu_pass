#!/bin/sh

# Blatantly plagiarized and improved from passmenu

DMENU="$(command -v dmenu)"
PREFIX="${PASSWORD_STORE_DIR:-'~/.password-store'}"

# helpers

die() {
    echo Error: "$@" >&2
    exit 1
}

do_dmenu() {
    "$DMENU" -i
}

do_pass() {
    pass "$@" 2>/dev/null
}

usage() {
    cat <<EOF
Usage: $(basename "$0") [type,clip [pass,otp,user]]
EOF
}

# Options

case "$1" in
    -h*|--h*|-?) usage
              exit ;;
esac

CONTENT="${2:-"$(printf 'password\notp\nusername' | "$DMENU")"}"
[ -z "$CONTENT" ] && die CONTENT was not provided
case "$CONTENT" in
    user*|pass*|otp) : ;;
    *) die CONTENT `"$CONTENT"` is invalid
esac

ACTION="${1:-"$(printf 'type\nclipboard' | "$DMENU")"}"
[ -z "$ACTION" ] && die ACTION was not provided
case "$ACTION" in
    type|clip*) : ;;
    *) die ACTION `"$ACTION"` is invalid
esac

ENTRY="$(find "$PREFIX" -name '*.gpg' | sed "s;^${PREFIX}/\?;; ; s;.gpg\$;;" | do_dmenu)"
[ -z "$ENTRY" ] && die ENTRY was not provided

case "$CONTENT" in
    user*)
        if ! do_pass show "$ENTRY" | grep -i '^user\(name\)\?:' 2>/dev/null | sed 's;^user\(name\)\?:\(.*\)$;\2;i' ; then
            printf '%s' "$ENTRY" | sed 's;.*/;;'
        fi ;;
    pass*)
        if PASSWORD="$(do_pass show "$ENTRY" | grep -i '^pass\(word\)\?:' 2>/dev/null)" ; then
            printf '%s' "$PASSWORD" |
        else
        { do_pass show "$ENTRY" | grep -i '^pass\(word\)\?:' 2>/dev/null } | sed 's;^pass\(word\)\?:\(.*\)$;\2;i'
        echo "$?"
        if ! : ; then
            do_pass show "$ENTRY" 1>&2 | head -n 1 1>&2
        fi ;;
    otp) do_pass otp "$ENTRY" | tail -n 1 ;;
esac | \
    case "$ACTION" in
        clip*) xclip -selection c ;;
        type) tr -d '\n' | xdotool type --clearmodifiers --file - ;;
    esac

# Notification

notify-send \
    -c transient \
    "${ACTION} ${CONTENT}" \
    "$ENTRY"

#!/bin/sh

if_exists() {
    command -v "$1" >/dev/null 2>&1
}

run_if_exists() {
    CMD="$1"
    shift
    if_exists "$CMD" && "$CMD" "$@" &
}

# audio
if if_exists pactl ; then
    if if_exists pipewire; then
        pipewire &
    else
        run_if_exists pulseaudio --start
    fi

    until pactl info >/dev/null 2>&1 ; do
        sleep 1
    done

    mic-push-to-talk.sh off
    pactl set-source-volume "$(pactl list short sources | grep 'alsa_input' | cut -f 1)" '50%' '50%'

    if if_exists qjackctl ; then
        qjackctl &
        run_if_exists cadence
        until jack_control status | grep 'started' >/dev/null 2>&1 ; do
            sleep 1
        done
    else
        "$XDG_CONFIG_HOME"/pulse/pulse-nonjack.sh
    fi

    kill -36 "$(pidof dwmblocks)"

    run_if_exists mpd
fi &

# transmission
if if_exists transmission-daemon ; then
    transmission-daemon

    if if_exists transmission-qt ; then
        transmission-qt &
    elif if_exists transmission-gtk ; then
        transmission-gtk &
    fi
fi &

# Push To Talk
run_if_exists xbindkeys -f "$XDG_CONFIG_HOME"/xbindkeys/config
# turn auto-repeat off for mute key
run_if_exists xset -r 121

if if_exists redshift-qt ; then
    redshift-qt &
elif if_exists redshift-gtk ; then
    redshift-gtk &
fi

run_if_exists blueman-applet
run_if_exists dunst
run_if_exists dwmblocks
run_if_exists numlockx

# Hang the system until we have set the wallpaper
wallpaper.sh
